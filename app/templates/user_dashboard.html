
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIRECTORATE OF ECONOMICS AND STATISTICS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --primary: #1e5a8e;
        --primary-dark: #14436b;
        --primary-light: #2b6fa8;
        --secondary: #fbbf24;
        --success: #10b981;
        --warning: #fbbf24;
        --danger: #ef4444;
        --info: #3b82f6;
        --dark: #0c3d5d;
        --gray-50: #f8fafc;
        --gray-100: #f1f5f9;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e1;
        --gray-600: #475569;
        --gray-700: #334155;
        --gray-800: #1e293b;
        --gray-900: #0f172a;
        --border-radius: 12px;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #1e5a8e;
        min-height: 100vh;
        padding: 2rem 1rem;
        color: var(--gray-800);
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Updated Header with Grid Layout */
    .header {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-lg);
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 2rem;
    }

    .logo {
        height: 100px;
        width: 100px;
        object-fit: contain;
    }

    .header-content {
        text-align: center;
    }

    .header-content h1 {
        font-size: 1.35rem;
        font-weight: 600;
        color: var(--primary);
        margin: 0;
        line-height: 1.4;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: var(--gray-50);
        border-radius: 8px;
        border: 1px solid var(--gray-200);
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
        min-width: 200px;
    }

    .user-info:hover {
        background: var(--gray-100);
        border-color: var(--gray-300);
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.125rem;
        flex-shrink: 0;
    }

    .user-details {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .user-name {
        font-weight: 600;
        color: var(--gray-900);
        font-size: 0.875rem;
    }

    .user-role {
        font-size: 0.75rem;
        color: var(--gray-600);
    }

    .dropdown-icon {
        color: var(--gray-600);
        font-size: 0.75rem;
        transition: transform 0.2s;
    }

    .user-info.active .dropdown-icon {
        transform: rotate(180deg);
    }

    .user-dropdown {
        position: absolute;
        top: calc(100% + 0.5rem);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow-xl);
        border: 1px solid var(--gray-200);
        min-width: 280px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s;
        z-index: 1000;
    }

    .user-dropdown.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-header {
        padding: 1.25rem;
        border-bottom: 2px solid var(--gray-100);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .dropdown-header .user-avatar {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
    }

    .dropdown-header-info h4 {
        font-size: 1rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
    }

    .dropdown-header-info p {
        font-size: 0.75rem;
        color: var(--gray-600);
    }

    .dropdown-menu {
        padding: 0.5rem;
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        color: var(--gray-700);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
    }

    .dropdown-item:hover {
        background: var(--gray-50);
        color: var(--gray-900);
    }

    .dropdown-item i {
        width: 1.25rem;
        font-size: 1rem;
    }

    .dropdown-item.logout {
        color: var(--danger);
        border-top: 1px solid var(--gray-100);
        margin-top: 0.5rem;
    }

    .dropdown-item.logout:hover {
        background: #fee2e2;
    }

    .card {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--gray-100);
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .card-title i {
        color: var(--primary);
    }

    .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .select-box, .input {
        padding: 0.875rem 1rem;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.2s;
        background: white;
        color: var(--gray-900);
        width: 100%;
    }

    .select-box:focus, .input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(30, 90, 142, 0.1);
    }

    .btn {
        padding: 0.875rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
        white-space: nowrap;
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }

    .btn:active:not(:disabled) {
        transform: translateY(0);
    }

    .btn-primary {
        background: var(--secondary);
        color: var(--dark);
        font-weight: 700;
    }

    .btn-primary:hover:not(:disabled) {
        background: #f59e0b;
    }

    .btn-success {
        background: var(--success);
        color: white;
    }

    .btn-view {
        background: var(--info);
        color: white;
    }

    .btn-danger {
        background: var(--danger);
        color: white;
    }

    .btn-edit {
        background: var(--warning);
        color: white;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
    }

    .divider {
        height: 2px;
        background: var(--gray-100);
        margin: 1.5rem 0;
    }

    .upload-section {
        background: var(--gray-50);
        padding: 1.5rem;
        border-radius: 8px;
        border: 2px dashed var(--gray-300);
    }

    .upload-section h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .table-container {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--gray-200);
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
    }

    .table thead {
        background: var(--dark);
    }

    .table thead th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: white;
        white-space: nowrap;
    }

    .table tbody tr {
        border-bottom: 1px solid var(--gray-200);
        transition: background 0.2s;
    }

    .table tbody tr:hover {
        background: var(--gray-50);
    }

    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
    }

    .action-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--gray-500);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }

    .badge-primary {
        background: var(--primary);
        color: white;
    }

    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .modal.active {
        display: flex;
        animation: fadeIn 0.2s ease-in;
    }

    .modal-content {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
        animation: slideUp 0.3s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--gray-100);
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
    }

    .modal-footer {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px solid var(--gray-100);
    }

    .btn-ghost {
        background: transparent;
        color: var(--gray-700);
        border: 2px solid var(--gray-300);
    }

    .btn-ghost:hover {
        background: var(--gray-50);
        border-color: var(--gray-400);
    }

    .profile-modal {
        max-width: 420px;
        padding: 0;
        overflow: hidden;
    }

    .profile-header {
        background: linear-gradient(135deg, #1e5a8e, #2563eb);
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 14px;
        color: white;
    }

    .profile-avatar {
        width: 56px;
        height: 56px;
        background: white;
        color: #1e5a8e;
        font-size: 22px;
        font-weight: 700;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .profile-body {
        padding: 20px;
    }

    .profile-field {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .profile-field span {
        color: #64748b;
        font-size: 14px;
    }

    .profile-field strong {
        font-size: 14px;
        color: #0f172a;
    }

    #profileTitle {
        margin: 0;
    }

    #profileSubTitle {
        font-size: 12px;
        opacity: 0.85;
    }

    @media (max-width: 968px) {
        .header {
            grid-template-columns: auto 1fr;
            gap: 1rem;
            padding: 1.25rem 1.5rem;
        }

        .header-content {
            grid-column: 1 / -1;
        }

        .header-content h1 {
            font-size: 0.95rem;
        }

        .user-info {
            grid-column: 1 / -1;
            justify-self: center;
        }
    }

    @media (max-width: 768px) {
        .controls {
            grid-template-columns: 1fr;
        }

        .action-group {
            flex-direction: column;
        }

        .action-group .btn {
            width: 100%;
        }

        /* .logo {
            height: 450px;
            width: 450px;
        } */

        .user-info {
            width: 100%;
            max-width: 300px;
        }
    }

    @media (max-width: 640px) {
        body {
            padding: 1rem 0.5rem;
        }

        .header {
            padding: 1rem;
        }

        

        .header-content h1 {
            font-size: 0.8rem;
        }

        .card {
            padding: 1.5rem;
        }
    }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="\static\images\py_logo.jpeg" alt="Logo" class="logo">
        
        <div class="header-content">
        <h1>DIRECTORATE OF ECONOMICS AND STATISTICS </h1>
        <h1 style="color: #cc6600;">பொருளாதாரம் மற்றும் புள்ளியியல் இயக்ககம்</h1>
    </div>
        
        <div class="user-info" onclick="toggleUserDropdown()">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-details">
                <div class="user-name" id="currentUserName">Loading...</div>
                <div class="user-role" id="currentUserDept">Department</div>
            </div>
            <i class="fas fa-chevron-down dropdown-icon"></i>
            
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-header">
                    <div class="user-avatar" id="dropdownAvatar">U</div>
                    <div class="dropdown-header-info">
                        <h4 id="dropdownUserName">User</h4>
                        <p id="dropdownUserDept">Department</p>
                    </div>
                </div>
                <div class="dropdown-menu">
                    <button class="dropdown-item" onclick="openProfileFromMenu(event)">
                        <i class="fas fa-user-circle"></i>
                        <span>View Profile</span>
                    </button>
                    <button class="dropdown-item" onclick="openChangePassword(); event.stopPropagation();">
                        <i class="fas fa-key"></i>
                        <span>Change Password</span>
                    </button>
                    <button class="dropdown-item logout" onclick="logout(); event.stopPropagation();">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- REGISTER SECTION -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-database"></i> Department Transaction Registers
            </div>
        </div>

        <div class="controls">
            <div class="form-group">
                <select id="registerSelect" class="select-box">
                    <option value="">-- Select Register --</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="downloadTemplate()">
                <i class="fas fa-download"></i> Download Template
            </button>

            <button class="btn btn-view" onclick="viewData()">
                <i class="fas fa-search"></i> View Data
            </button>
            <button class="btn btn-edit btn-sm" onclick="viewData()">
                <i class="fas fa-edit"></i> Edit Data
            </button>
        </div>

        <div class="divider"></div>

        <!-- UPLOAD SECTION -->
        <div class="upload-section">
            <h4><i class="fas fa-cloud-upload-alt"></i> Upload Register File</h4>
            <div class="controls">
                <input type="file" id="uploadFile" class="input" accept=".xlsx">
                <button class="btn btn-success" onclick="uploadRegister()">
                    <i class="fas fa-upload"></i> Upload Register
                </button>
            </div>
        </div>
    </div>

    <!-- UPLOAD HISTORY -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-history"></i> Upload History
            </div>
            <span class="badge badge-primary" id="uploadCount">0 Uploads</span>
        </div>

        <div class="table-container">
            <table class="table">
                <thead>
                            <thead>
                        <tr>
                            <th>ID</th>
                            <th>Filename</th>
                            <th>Target Table</th>
                            <th>Uploaded On</th>
                            <th>Status</th>
                            <th style="width: 300px;">Actions</th>
                        </tr>
                    </thead>
                <tbody id="uploadHistory"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Change Password</h3>
        </div>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div class="form-group">
                <label style="font-weight: 600; color: var(--gray-700); font-size: 0.875rem;">Current Password</label>
                <input type="password" id="currentPassword" class="input" placeholder="Enter current password">
            </div>
            <div class="form-group">
                <label style="font-weight: 600; color: var(--gray-700); font-size: 0.875rem;">New Password</label>
                <input type="password" id="newPassword" class="input" placeholder="Enter new password">
            </div>
            <div class="form-group">
                <label style="font-weight: 600; color: var(--gray-700); font-size: 0.875rem;">Confirm New Password</label>
                <input type="password" id="confirmPassword" class="input" placeholder="Confirm new password">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeChangePasswordModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitChangePassword()">
                <i class="fas fa-save"></i> Update Password
            </button>
        </div>
    </div>
</div>

<div id="profileModal" class="modal">
  <div class="modal-content profile-modal">

    <div class="profile-header">
      <!-- <div class="profile-avatar" id="profileAvatar">U</div> -->
      <div>
        <h3 id="profileTitle">My Profile</h3><br>
        <small id="profileSubTitle">Account Details</small>
      </div>
    </div>

    <div class="profile-body">
      <div class="profile-field">
        <span>Username :</span>
        <strong id="profileUsername"></strong>
      </div>

      <div class="profile-field">
        <span>Department :</span>
        <strong id="profileDepartment"></strong>
      </div>

      <div class="profile-field">
        <span>Role :</span>
        <strong id="profileRole"></strong>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeProfileModal()">Close</button>
    </div>

  </div>
</div>

<script>
let registers = [];
let department = "";
let currentUser = {};

// ===== TOAST POPUP =====
function showToast(msg, type = "success") {
    const colors = { success:"#16a34a", error:"#dc2626", warn:"#f59e0b", info:"#2563eb" };
    const d = document.createElement("div");
    d.style = `position:fixed;top:20px;right:20px;background:${colors[type]};
               color:#fff;padding:12px 18px;border-radius:8px;
               box-shadow:0 6px 18px rgba(0,0,0,.2);z-index:9999;
               font-weight:600;animation:slideIn 0.3s ease`;
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(() => {
        d.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => d.remove(), 300);
    }, 3000);
}

// Add animation styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);

// ===== CONFIRM MODAL =====
function showConfirm(msg, yesFn) {
    document.body.insertAdjacentHTML("beforeend", `
      <div id="cfx" style="position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:flex;align-items:center;justify-content:center;z-index:9999">
        <div style="background:#fff;padding:22px 26px;border-radius:10px;text-align:center;max-width:400px">
          <p style="margin-bottom:16px;font-size:16px">${msg}</p>
          <button id="cfxYes" style="margin-right:10px;background:#dc2626;color:#fff;padding:8px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600">Yes</button>
          <button id="cfxNo" style="padding:8px 20px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-weight:600">Cancel</button>
        </div>
      </div>`);

    cfxYes.onclick = () => { document.getElementById("cfx").remove(); yesFn(); }
    cfxNo.onclick = () => document.getElementById("cfx").remove();
}


document.addEventListener("DOMContentLoaded", init);

async function init() {
    await loadCurrentUser();
    await loadRegisters();
    await loadUploadHistory();
}

/* LOAD CURRENT USER */
async function loadCurrentUser() {
    try {
        const profile = await fetch("/api/current_user").then(r => r.json());
        currentUser = profile;
        department = profile.department || "";

        const initial = profile.username ? profile.username.charAt(0).toUpperCase() : "U";
        
        document.getElementById("currentUserName").textContent = profile.username || "User";
        document.getElementById("currentUserDept").textContent = profile.department || "Department";
        document.getElementById("userAvatar").textContent = initial;
        document.getElementById("dropdownAvatar").textContent = initial;
        document.getElementById("dropdownUserName").textContent = profile.username || "User";
        document.getElementById("dropdownUserDept").textContent = profile.department || "Department";
    } catch (e) {
        console.error("Failed to load user profile", e);
        showToast("Failed to load user profile", "error");
    }
}

/* TOGGLE USER DROPDOWN */
function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const userInfo = document.querySelector('.user-info');
    const dropdown = document.getElementById('userDropdown');
    
    if (dropdown && !userInfo?.contains(event.target)) {
        dropdown.classList.remove('active');
    }
});

function viewProfile() {
    document.getElementById('userDropdown').classList.remove('active');

    document.getElementById("profileUsername").innerText = currentUser.username;
    document.getElementById("profileDepartment").innerText = currentUser.department;
    document.getElementById("profileRole").innerText = currentUser.role;

    document.getElementById("profileModal").classList.add("active");
}

function closeProfileModal() {
    document.getElementById("profileModal").classList.remove("active");
}

function openProfileFromMenu(e) {
    e.stopPropagation();
    document.getElementById('userDropdown').classList.remove('active');
    viewProfile();
}

/* CHANGE PASSWORD */
function openChangePassword() {
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) dropdown.classList.remove('active');
    
    const modal = document.getElementById('changePasswordModal');
    if (modal) modal.classList.add('active');
}

function closeChangePasswordModal() {
    const modal = document.getElementById('changePasswordModal');
    if (modal) modal.classList.remove('active');
    
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
}

async function submitChangePassword() {
    const currentPassword = document.getElementById('currentPassword')?.value;
    const newPassword = document.getElementById('newPassword')?.value;
    const confirmPassword = document.getElementById('confirmPassword')?.value;

    if (!currentPassword || !newPassword || !confirmPassword) {
        return showToast('Please fill in all fields', 'error');
    }

    if (newPassword !== confirmPassword) {
        return showToast('New passwords do not match', 'error');
    }

    if (newPassword.length < 6) {
        return showToast('Password must be at least 6 characters long', 'error');
    }

    try {
        const res = await fetch('/api/change_password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });

        const data = await res.json();

        if (res.ok) {
            showToast(data.message || 'Password changed successfully!', 'success');
            closeChangePasswordModal();
        } else {
            showToast(data.error || "Failed to change password", "error");
        }
    } catch (e) {
        showToast("Failed to change password", "error");
    }
}

/* LOGOUT */
function logout() {
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) dropdown.classList.remove('active');
    
    showConfirm("Are you sure you want to logout?", () => {
        window.location.href = '/logout';
    });
}

/* LOAD REGISTERS */
async function loadRegisters() {
    const res = await fetch("/api/transaction_tables");
    registers = await res.json();
    console.log("Departments API:", registers.label);
    const select = document.getElementById("registerSelect");
    select.innerHTML = `<option value="">-- Select Register --</option>`;

    registers.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.table_name;
        opt.textContent = r.label;
        select.appendChild(opt);
        console.log("Departments API:", r.label);
    });
}

/* DOWNLOAD TEMPLATE */
function downloadTemplate() {
    const table = document.getElementById("registerSelect").value;
    if (!table) return showToast("Please select a register.", "error");

    window.location.href = `/download_register_template?table=${encodeURIComponent(table)}&t=${Date.now()}`;
}

/* VIEW DATA */
function viewData() {
    const table = document.getElementById("registerSelect").value;
    if (!table) return showToast("Please select a register.", "error");

    window.location.href = `/view_excel_data?table=${encodeURIComponent(table)}&mode=view`;
}

/* UPLOAD REGISTER */
async function uploadRegister() {
    const table = document.getElementById("registerSelect").value;
    const file = document.getElementById("uploadFile").files[0];

    if (!table) return showToast("Please select a register.", "error");
    if (!file) return showToast("Please choose a file.", "error");

    const fd = new FormData();
    fd.append("file", file);
    fd.append("table_name", table);

    try {
        const res = await fetch("/upload_transaction", {
            method: "POST",
            body: fd
        });

        const out = await res.json();
        if (res.ok) {
            showToast(out.message || "Upload successful!", "success");
            document.getElementById("uploadFile").value = "";
            loadUploadHistory();
        } else {
            showToast(out.error || "Upload failed", "error");
        }
    } catch (e) {
        showToast("Upload failed", "error");
    }
}

/* LOAD HISTORY */
async function loadUploadHistory() {
    try {
        const rows = await fetch(`/uploads?department=${encodeURIComponent(currentUser.department)}`).then(r => r.json());
        
        const tbody = document.getElementById("uploadHistory");
        document.getElementById("uploadCount").textContent = `${rows.length} Upload${rows.length !== 1 ? 's' : ''}`;

        if (!rows || rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:3rem;color:#9ca3af">No upload history found</td></tr>`;
            return;
        }

        tbody.innerHTML = rows.map(r => {
            // ✅ Status Logic: NULL = Pending, 0 = Rejected, 1 = Approved
            let statusBadge = '';
            let canEdit = false;
            
            if (r.status_ === null || r.status_ === undefined) {
                statusBadge = '<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending</span>';
                canEdit = true;  // ✅ Can edit when pending
            } else if (r.status_ === 1) {
                statusBadge = '<span class="status-badge status-approved"><i class="fas fa-check-circle"></i> Approved</span>';
                canEdit = false;  // ✅ Cannot edit when approved
            } else if (r.status_ === 0) {
                statusBadge = '<span class="status-badge status-rejected"><i class="fas fa-times-circle"></i> Rejected</span>';
                canEdit = true;  // ✅ Can edit when rejected
            }

            // ✅ Show Edit button only if status allows
            const editBtn = canEdit 
                ? `<button class="btn btn-edit btn-sm" onclick="openEditPage('${escapeJs(r.table_name)}', ${r.id})">
                       <i class="fas fa-edit"></i> Edit
                   </button>`
                : '';

            return `
                <tr>
                    <td><strong>${r.id}</strong></td>
                    <td>${escapeHtml(r.filename)}</td>
                    <td>${escapeHtml(r.table_name)}</td>
                    <td>${new Date(r.uploaded_on).toLocaleString()}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="action-group">
                            <button class="btn btn-view btn-sm" onclick="openViewPage('${escapeJs(r.table_name)}', ${r.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            ${editBtn}
                            <button class="btn btn-danger btn-sm" onclick="deleteUpload(${r.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    } catch (e) {
        console.error("Failed to load upload history", e);
        showToast("Failed to load upload history", "error");
    }
}

function openEditPage(table) {
    window.location.href = `/view_excel_data?table=${encodeURIComponent(table)}&mode=edit`;
}

function openViewPage(table) {
    window.location.href = `/view_excel_data?table=${encodeURIComponent(table)}&mode=view`;
}

/* DELETE UPLOAD */
async function deleteUpload(id) {
    return showConfirm("Are you sure you want to delete this upload?", async () => {
        try {
            const res = await fetch(`/uploads/${id}`, { method: "DELETE" });
            const out = await res.json();
            
            if (res.ok) {
                showToast(out.message || "Deleted successfully", "success");
                loadUploadHistory();
            } else {
                showToast(out.error || "Delete failed", "error");
            }
        } catch (e) {
            showToast("Delete failed", "error");
        }
    });
}

/* UTILITY FUNCTIONS */
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeJs(text) {
    return String(text).replace(/'/g, "\\'").replace(/"/g, '\\"');
}

// Close modal on background click
document.getElementById('changePasswordModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'changePasswordModal') closeChangePasswordModal();
});
</script>
</body>
</html>
