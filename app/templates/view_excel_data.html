<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Data Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
            color: var(--gray-800);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-xl);
            margin-bottom: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .header-info h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .header-info h1 i {
            color: var(--primary);
        }

        .header-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.875rem;
            color: var(--gray-600);
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .meta-item strong {
            color: var(--gray-900);
        }

        .badge {
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        .badge-edit {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-view {
            background: #dbeafe;
            color: #1e40af;
        }

        .controls {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-back {
            background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-700) 100%);
            color: white;
        }

        .btn-download {
            background: var(--success);
            color: white;
        }

        .btn-add {
            background: var(--warning);
            color: white;
        }

        .btn-save {
            background: var(--success);
            color: white;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .search-section {
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            max-width: 500px;
            padding: 0.875rem 1rem 0.875rem 2.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'%3E%3C/path%3E%3C/svg%3E") no-repeat 0.875rem center;
            background-size: 1.25rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .table-wrapper {
            max-height: 65vh;
            overflow: auto;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-800) 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        tbody tr {
            border-bottom: 1px solid var(--gray-200);
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: var(--gray-50);
        }

        td {
            padding: 0.875rem 1rem;
            vertical-align: middle;
        }

        td[contenteditable="true"] {
            background: #fffbeb;
            cursor: text;
            border-radius: 4px;
        }

        td[contenteditable="true"]:focus {
            outline: 2px solid var(--warning);
            background: white;
        }

        .fk-cell {
            cursor: pointer;
            position: relative;
            background: #f0f9ff;
            border-radius: 4px;
        }

        .fk-cell:hover {
            background: #dbeafe;
        }

        .dropdown {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 2px solid var(--primary);
            background: white;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .dropdown:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .status-message {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-xl);
            display: none;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
            z-index: 9999;
        }

        .status-message.show {
            display: flex;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .small-text {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-style: italic;
        }

        .editable-indicator {
            background: #fef3c7;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--warning);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .controls {
                width: 100%;
                flex-direction: column;
            }

            .controls .btn {
                width: 100%;
                justify-content: center;
            }

            .search-input {
                max-width: 100%;
            }

            .table-wrapper {
                max-height: 50vh;
            }
        }

        /* Scrollbar styling */
        .table-wrapper::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 5px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <div class="header-info">
                    <h1>
                        <i class="fas fa-table"></i>
                        Excel Data Viewer
                    </h1>
                    <div class="header-meta">
                        <div class="meta-item">
                            <i class="fas fa-database"></i>
                            <span>Table: <strong id="tableNameLabel"></strong></span>
                        </div>
                        <div class="meta-item">
                            <span class="badge" id="modeBadge">
                                <i class="fas fa-eye"></i>
                                <span id="modeLabel">VIEW</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-back" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-download" onclick="downloadExcel()">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button class="btn btn-save" id="btnReapprove" style="display:none;" onclick="requestReApproval()">
    <i class="fas fa-paper-plane"></i> Request Re-Approval
</button>
                    <button class="btn btn-add" id="btnAddRow" style="display:none;" onclick="addNewRow()">
                        <i class="fas fa-plus"></i> Add Row
                    </button>
                </div>
            </div>

            <div class="search-section">
                <input id="searchInput" type="text" class="search-input" 
                       placeholder="Search table data..." oninput="filterTable()">
            </div>

            <div class="table-wrapper">
                <table id="excelTable">
                    <tbody>
                        <tr>
                            <td colspan="100" class="empty-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="status-message" id="statusMessage">
        <i class="fas fa-check-circle"></i>
        <span id="statusText">Saved</span>
    </div>

 <script>
    const tableName = "{{ table }}";
    const pageMode = "{{ mode }}";
    const isEditable = (pageMode === "edit");

    // ✅ URL params
    const urlParams = new URLSearchParams(window.location.search);
    const uploadId = urlParams.get("upload_id");
    const approvalMode = urlParams.get("approval_mode") === "true";   // opened by approver
    const onlyRejected = urlParams.get("only_rejected") === "true";   // opened by user rejected edit
    if (onlyRejected && isEditable) {

        const btn = document.getElementById("btnReapprove");
        if (btn) btn.style.display = "inline-flex";
    }

    // ✅ approver/admin approval UI only in approval_mode
    const canApproveReject = approvalMode;

    document.getElementById("tableNameLabel").innerText = tableName;
    document.getElementById("modeLabel").innerText = pageMode.toUpperCase();

    const modeBadge = document.getElementById("modeBadge");
    if (isEditable) {
        modeBadge.className = "badge badge-edit";
        modeBadge.innerHTML = '<i class="fas fa-edit"></i> <span>EDIT MODE</span>';

        // ✅ Allow Add Row only for approver flow
        if (canApproveReject) {
            document.getElementById("btnAddRow").style.display = "inline-flex";
        } else {
            document.getElementById("btnAddRow").style.display = "none";
        }
    } else {
        modeBadge.className = "badge badge-view";
        modeBadge.innerHTML = '<i class="fas fa-eye"></i> <span>VIEW MODE</span>';
        document.getElementById("btnAddRow").style.display = "none";
    }

    let metadataLabels = {};
    let tableHeaders = [];
    let lookupCache = {};
    let pkColumn = "id";

    document.addEventListener("DOMContentLoaded", loadTable);

    async function loadTable() {
        if (!tableName) {
            alert("Missing table parameter");
            return;
        }

        try {
            // 1) primary key
            const pkRes = await fetch(`/api/primary_key?table=${encodeURIComponent(tableName)}`);
            const pkData = await pkRes.json();
            pkColumn = pkData.pk || "id";

            // 2) metadata labels
            const mRes = await fetch(`/api/column_metadata?table=${encodeURIComponent(tableName)}`);
            metadataLabels = await mRes.json() || {};

            // 3) columns
            const colRes = await fetch(`/api/table_columns?table=${encodeURIComponent(tableName)}`);
            tableHeaders = await colRes.json();

            // 4) lookup lists for *_id cols
            const fkCols = tableHeaders.filter(c => c.endsWith("_id"));
            for (const col of fkCols) {
                const lk = await fetch(`/api/lookup?col=${encodeURIComponent(col)}`);
                lookupCache[col] = await lk.json();
            }

            // 5) rows with upload_id + only_rejected support
            let apiUrl = `/api/excel_data?table=${encodeURIComponent(tableName)}`;
            if (uploadId) apiUrl += `&upload_id=${encodeURIComponent(uploadId)}`;
            if (onlyRejected) apiUrl += `&only_rejected=true`;

            const rowsRes = await fetch(apiUrl);
            const rows = await rowsRes.json();

            renderTable(rows);
        } catch (e) {
            console.error("Failed to load table:", e);
            document.getElementById("excelTable").innerHTML = `
                <tbody>
                    <tr>
                        <td colspan="100" class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Failed to load data</p>
                        </td>
                    </tr>
                </tbody>
            `;
        }
    }

    // ===================== HELPERS =====================
    function pretty(col) {
        return metadataLabels[col]
            || col.replace(/_/g, " ").replace(/\b\w/g, s => s.toUpperCase());
    }

    function fkText(col, id) {
        const list = lookupCache[col] || [];
        const found = list.find(x => String(x.id) === String(id));
        return found ? found.name : "";
    }

    function isNonEditable(col) {
        return (
            col === pkColumn ||
            ["created_by", "created_date", "updated_by", "updated_date", "status_"].includes(col)
        );
    }

    function isApprovalColumn(col) {
        return col === "is_approved";
    }

    // convert db value -> status
    function approvalStatus(val) {
        if (val === null || val === undefined || val === "") return null;
        const s = String(val).toLowerCase();
        if (s === "1" || s === "true") return 1;
        if (s === "0" || s === "false") return 0;
        return null;
    }

    // ===================== BULK SELECT (approver only) =====================
    async function bulkApprove(status) {
        if (!canApproveReject) return;

        const rows = document.querySelectorAll("#excelTable tbody tr");
        for (const tr of rows) {
            const pk = tr.dataset.pk;
            if (!pk) continue;

            await updateApproval(pk, status);

            const acceptCb = tr.querySelector(".approve-accept");
            const rejectCb = tr.querySelector(".approve-reject");

            if (acceptCb && rejectCb) {
                if (status === 1) {
                    acceptCb.checked = true;
                    rejectCb.checked = false;
                } else if (status === 0) {
                    acceptCb.checked = false;
                    rejectCb.checked = true;
                } else {
                    acceptCb.checked = false;
                    rejectCb.checked = false;
                }
            }
        }

        flash("Updated all rows");
    }

    // ===================== RENDER TABLE =====================
    function renderTable(rows) {
        // ✅ remove previous bulk controls if reloaded
        document.querySelectorAll(".bulk-controls").forEach(x => x.remove());

        let html = "<thead><tr>";
        tableHeaders.forEach(h => html += `<th>${pretty(h)}</th>`);
        if (isEditable) html += "<th style='width: 220px;'>Actions</th>";
        html += "</tr></thead><tbody id='tableBody'>";

        if (!rows.length) {
            html += `
                <tr>
                    <td colspan="${tableHeaders.length + 1}" class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No records found</p>
                    </td>
                </tr>
            `;
            document.getElementById("excelTable").innerHTML = html;
            return;
        }

        // ✅ BULK controls only for approver
        if (isEditable && canApproveReject && tableHeaders.includes("is_approved")) {
            const bulkHtml = `
                <div class="bulk-controls" style="display:flex; gap:10px; flex-wrap:wrap; margin:12px 0;">
                    <button class="btn btn-save" onclick="bulkApprove(1)">✅ Select All Accept</button>
                    <button class="btn btn-delete" onclick="bulkApprove(0)">❌ Select All Reject</button>
                    <button class="btn btn-add" onclick="bulkApprove(null)">⏳ Clear All (Pending)</button>
                </div>
            `;
            document.querySelector(".search-section").insertAdjacentHTML("afterend", bulkHtml);
        }

        rows.forEach(r => {
            const pkVal = r[pkColumn];
            html += `<tr data-pk="${pkVal}">`;

            tableHeaders.forEach(col => {
                const val = r[col] ?? "";

                // VIEW MODE OR NON-EDITABLE
                if (!isEditable || isNonEditable(col)) {

                    if (isApprovalColumn(col)) {
                        const st = approvalStatus(val);
                        html += `
                            <td style="font-weight:600;text-align:center;">
                                ${st === 1 ? "✅ Accepted" : st === 0 ? "❌ Rejected" : "⏳ Pending"}
                            </td>
                        `;
                    } else {
                        const displayVal = col.endsWith("_id") ? fkText(col, val) : val;
                        html += `<td>${displayVal || '<span class="small-text">(empty)</span>'}</td>`;
                    }

                } else {

                    // EDIT MODE
                    if (col.endsWith("_id")) {
                        html += `
                            <td class="fk-cell" data-col="${col}" data-pk="${pkVal}" onclick="openFkDropdown(event,this)">
                                ${fkText(col, val) || '<span class="small-text">Click to select</span>'}
                            </td>`;
                    }
                    else if (isApprovalColumn(col)) {

                        // ✅ user edit mode: show text only
                        if (!canApproveReject) {
                            const st = approvalStatus(val);
                            html += `
                                <td style="font-weight:600;text-align:center;">
                                    ${st === 1 ? "✅ Accepted" : st === 0 ? "❌ Rejected" : "⏳ Pending"}
                                </td>
                            `;
                        } else {
                            // ✅ approver: show accept/reject checkboxes
                            const st = approvalStatus(val);
                            const acceptChecked = st === 1;
                            const rejectChecked = st === 0;

                            html += `
                                <td style="text-align:center;">
                                    <label style="margin-right:10px; cursor:pointer;">
                                        <input type="checkbox"
                                            class="approve-accept"
                                            ${acceptChecked ? "checked" : ""}
                                            onchange="onAcceptRejectChange('${pkVal}', 1, this)">
                                        ✅
                                    </label>

                                    <label style="cursor:pointer;">
                                        <input type="checkbox"
                                            class="approve-reject"
                                            ${rejectChecked ? "checked" : ""}
                                            onchange="onAcceptRejectChange('${pkVal}', 0, this)">
                                        ❌
                                    </label>
                                </td>
                            `;
                        }
                    }
                    else {
                        html += `
                            <td contenteditable="true"
                                onfocus="this.dataset.old=this.innerText"
                                onblur="saveCell('${pkVal}','${col}',this)">
                                ${val}
                            </td>`;
                    }
                }
            });

            // ACTION BUTTONS
            if (isEditable) {
                html += `
                    <td style="display:flex; gap:8px;">
                        <button class="btn btn-save" onclick="saveRow('${pkVal}', this)">
                            <i class="fas fa-save"></i> Save
                        </button>

                        ${canApproveReject ? `
                            <button class="btn btn-delete" onclick="deleteRow('${pkVal}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        ` : ""}
                    </td>`;
            }

            html += "</tr>";
        });

        html += "</tbody>";
        document.getElementById("excelTable").innerHTML = html;
    }

    // ===================== APPROVAL CHECKBOX HANDLING =====================
    async function onAcceptRejectChange(pk, changedValue, checkbox) {
        if (!canApproveReject) return;

        const tr = checkbox.closest("tr");
        const acceptCb = tr.querySelector(".approve-accept");
        const rejectCb = tr.querySelector(".approve-reject");

        let newValue = null;

        if (changedValue === 1) {
            if (checkbox.checked) {
                rejectCb.checked = false;
                newValue = 1;
            } else {
                newValue = null;
            }
        }

        if (changedValue === 0) {
            if (checkbox.checked) {
                acceptCb.checked = false;
                newValue = 0;
            } else {
                newValue = null;
            }
        }

        const ok = await updateApproval(pk, newValue);
        if (ok) flash("Saved successfully");
    }

    // ✅ Approver approval must use /api/set_row_status
    async function updateApproval(pk, value) {
        const res = await fetch("/api/set_row_status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                table: tableName,
                id: pk,
                status: value,
                upload_id: uploadId
            })
        });

        const out = await res.json();
        if (!res.ok) {
            alert(out.error || "Failed to update approval");
            return false;
        }
        return true;
    }

    // ===================== FK DROPDOWN =====================
    function openFkDropdown(event, td) {
        event.stopPropagation();

        const col = td.dataset.col;
        const pk = td.dataset.pk;
        const list = lookupCache[col] || [];

        td.innerHTML = "";
        const select = document.createElement("select");
        select.className = "dropdown";

        select.addEventListener("click", e => e.stopPropagation());

        select.add(new Option("-- Select --", ""));
        list.forEach(o => select.add(new Option(o.name, o.id)));

        select.onchange = async () => {
            const newVal = select.value;
            await updateFk(pk, col, newVal);
            td.innerText = select.options[select.selectedIndex].text;
            flash("Saved successfully");
        };

        td.appendChild(select);
        select.focus();
    }

    async function updateFk(pk, col, value) {
        await fetch("/api/update_excel_cell", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ table: tableName, id: pk, column: col, value })
        });
    }

    // ===================== NORMAL CELL SAVE =====================
    async function saveCell(pk, col, el) {
        const newVal = el.innerText.trim();
        const oldVal = el.dataset.old;

        if (newVal === oldVal) return;

        const res = await fetch("/api/update_excel_cell", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ table: tableName, id: pk, column: col, value: newVal })
        });

        const out = await res.json();
        if (!res.ok) {
            alert(out.error || "Failed to save");
            el.innerText = oldVal;
        } else {
            flash("Saved successfully");
        }
    }

    // ===================== SAVE FULL ROW BUTTON =====================
    async function saveRow(pk, btn) {
        const tr = btn.closest("tr");
        const tds = tr.querySelectorAll("td");

        for (let i = 0; i < tableHeaders.length; i++) {
            const col = tableHeaders[i];
            const td = tds[i];

            if (isNonEditable(col)) continue;

            // do not save approval from Save button
            if (isApprovalColumn(col)) continue;

            if (col.endsWith("_id")) continue;

            const value = td.innerText.trim();

            await fetch("/api/update_excel_cell", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ table: tableName, id: pk, column: col, value })
            });
        }

        flash("Row saved successfully");
    }

    // ===================== ADD ROW (approver only) =====================
    function addNewRow() {
        if (!canApproveReject) return;

        const tbody = document.getElementById("tableBody");
        const tr = document.createElement("tr");
        tr.style.background = "#f0fdf4";

        tableHeaders.forEach(col => {
            const td = document.createElement("td");

            if (isNonEditable(col)) {
                td.innerHTML = "<span class='small-text'>(auto-generated)</span>";
            }
            else if (col.endsWith("_id")) {
                const sel = document.createElement("select");
                sel.className = "dropdown";
                sel.add(new Option("-- Select --", ""));
                (lookupCache[col] || []).forEach(o => sel.add(new Option(o.name, o.id)));
                td.appendChild(sel);
            }
            else if (isApprovalColumn(col)) {
                td.innerHTML = "<span class='small-text'>(pending)</span>";
            }
            else {
                td.contentEditable = true;
                td.style.background = "#fffbeb";
            }

            tr.appendChild(td);
        });

        const actionTd = document.createElement("td");
        const saveBtn = document.createElement("button");
        saveBtn.className = "btn btn-save";
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
        saveBtn.onclick = () => saveNewRow(tr);
        actionTd.appendChild(saveBtn);
        tr.appendChild(actionTd);

        tbody.appendChild(tr);
        tr.scrollIntoView({ behavior:"smooth", block: "center" });
    }

    async function saveNewRow(tr) {
        if (!canApproveReject) return;

        const cells = tr.querySelectorAll("td");
        const rowData = {};

        tableHeaders.forEach((col, idx) => {
            const cell = cells[idx];

            if (isNonEditable(col)) return;

            if (col.endsWith("_id")) {
                const sel = cell.querySelector("select");
                if (sel && sel.value) rowData[col] = parseInt(sel.value);
            } else if (isApprovalColumn(col)) {
                // default pending
            } else {
                const value = cell.innerText.trim();
                if (value) rowData[col] = value;
            }
        });

        const res = await fetch("/api/add_excel_row", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ table: tableName, row_data: rowData })
        });

        const out = await res.json();
        if (!res.ok) {
            alert(out.error || "Failed to add row");
        } else {
            flash("Row added successfully");
            setTimeout(loadTable, 500);
        }
    }

    // ===================== DELETE ROW (approver only) =====================
    async function deleteRow(pk) {
        if (!canApproveReject) return;

        if (!confirm("Are you sure you want to delete this row?")) return;

        await fetch("/api/delete_excel_row", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ table: tableName, id: pk })
        });

        flash("Row deleted");
        setTimeout(loadTable, 500);
    }

    // ===================== UTILITIES =====================
    function flash(msg) {
        const el = document.getElementById("statusMessage");
        const text = document.getElementById("statusText");
        text.innerText = msg;
        el.classList.add("show");
        setTimeout(() => el.classList.remove("show"), 2000);
    }

    function filterTable() {
        const q = document.getElementById("searchInput").value.toLowerCase();
        document.querySelectorAll("#excelTable tbody tr").forEach(tr => {
            tr.style.display = tr.innerText.toLowerCase().includes(q) ? "" : "none";
        });
    }

    function goBack() {
        fetch("/api/current_user", { credentials: 'include' })
            .then(r => r.json())
            .then(u => window.location.href =
                u.role === "admin" ? "/admin_dashboard" :
                u.role === "approver" ? "/approver_dashboard" :
                "/user_dashboard"
            )
            .catch(() => window.location.href = "/user_dashboard");
    }

    function downloadExcel() {
        window.location.href = `/download_excel?table=${encodeURIComponent(tableName)}&filename=${tableName}.xlsx`;
    }
    async function requestReApproval() {
    if (!uploadId) {
        alert("upload_id missing");
        return;
    }

    if (!confirm("Request Re-Approval? This will send corrected rejected records to approver again.")) return;

    const res = await fetch("/api/request_reapproval", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            upload_id: uploadId,
            table: tableName
        })
    });

    const out = await res.json();
    if (!res.ok) {
        alert(out.error || "Failed to request reapproval");
        return;
    }

    flash("Re-Approval Requested ✅");

    setTimeout(() => {
        window.location.href = "/user_dashboard";
    }, 1200);
}

</script>



</body>
</html>